// Prisma schema for authentication tables
// Connects to shared Neon PostgreSQL database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table - managed by better-auth
model User {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String   @unique @db.VarChar(255)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  status        String   @default("active") @db.VarChar(20)
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamp()

  // Relations
  sessions      UserSession[]
  profile       UserProfile?
  tabPreference TabPreference?

  @@index([email])
  @@index([status])
  @@index([createdAt], name: "idx_users_created_at")
  @@map("users")
}

// User profiles table - background information
model UserProfile {
  userId                   String   @id @map("user_id") @db.Uuid
  programmingLanguages     Json     @default("[]") @map("programming_languages") @db.JsonB
  frameworks               Json     @default("[]") @db.JsonB
  softwareExperienceYears  Int      @default(0) @map("software_experience_years")
  roboticsPlatforms        Json     @default("[]") @map("robotics_platforms") @db.JsonB
  sensorsActuators         Json     @default("[]") @map("sensors_actuators") @db.JsonB
  hardwareExperienceYears  Int      @default(0) @map("hardware_experience_years")
  derivedExperienceLevel   String   @default("Beginner") @map("derived_experience_level") @db.VarChar(20)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt                DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([derivedExperienceLevel], name: "idx_derived_experience_level")
  @@index([softwareExperienceYears], name: "idx_software_experience")
  @@index([hardwareExperienceYears], name: "idx_hardware_experience")
  @@map("user_profiles")
}

// User sessions table - JWT authentication
model UserSession {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  tokenHash        String    @unique @map("token_hash") @db.VarChar(255)
  refreshTokenHash String?   @map("refresh_token_hash") @db.VarChar(255)
  ipAddress        String?   @map("ip_address") @db.Inet
  userAgent        String?   @map("user_agent") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamp()
  expiresAt        DateTime  @map("expires_at") @db.Timestamp()
  lastActivityAt   DateTime  @default(now()) @map("last_activity_at") @db.Timestamp()
  revoked          Boolean   @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_user_sessions_user_id")
  @@index([tokenHash], name: "idx_user_sessions_token")
  @@index([expiresAt], name: "idx_user_sessions_expires")
  @@index([lastActivityAt], name: "idx_user_sessions_activity")
  @@map("user_sessions")
}

// Tab preferences table - content view preferences
model TabPreference {
  userId    String   @id @map("user_id") @db.Uuid
  activeTab String   @default("original") @map("active_tab") @db.VarChar(20)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([updatedAt], name: "idx_tab_preferences_updated")
  @@map("tab_preferences")
}
