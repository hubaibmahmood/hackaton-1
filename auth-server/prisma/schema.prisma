// Prisma schema for authentication tables
// Connects to shared Neon PostgreSQL database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

}

// Users table - managed by better-auth
model User {
  id            String   @id @db.VarChar(255)
  name          String?  @db.VarChar(255)
  email         String   @unique @db.VarChar(255)
  password      String?  @map("password_hash") @db.VarChar(255)
  image         String?  @db.Text
  status        String   @default("active") @db.VarChar(20)
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamp()

  // Relations
  accounts      Account[]
  sessions      UserSession[]
  profile       UserProfile?
  tabPreference TabPreference?

  @@index([email])
  @@index([status])
  @@index([createdAt], name: "idx_users_created_at")
  @@map("users")
}

model Account {
  id           String  @id @db.VarChar(255)
  userId       String  @map("user_id") @db.VarChar(255)
  accountId    String  @map("account_id") @db.VarChar(255)
  providerId   String  @map("provider_id") @db.VarChar(255)
  type         String? @db.VarChar(255)
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String? @db.VarChar(255)
  scope              String? @db.VarChar(255)
  id_token           String? @db.Text
  session_state      String? @db.VarChar(255)
  password           String? @map("password_hash") @db.VarChar(255) // For email/password
  password_salt      String? @map("password_salt") @db.VarChar(255) // For some hash algorithms
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamp()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

// User profiles table - background information
model UserProfile {
  userId                   String   @id @map("user_id") @db.VarChar(255)
  programmingLanguages     Json     @default("[]") @map("programming_languages") @db.JsonB
  frameworks               Json     @default("[]") @db.JsonB
  softwareExperienceYears  Int      @default(0) @map("software_experience_years")
  roboticsPlatforms        Json     @default("[]") @map("robotics_platforms") @db.JsonB
  sensorsActuators         Json     @default("[]") @map("sensors_actuators") @db.JsonB
  hardwareExperienceYears  Int      @default(0) @map("hardware_experience_years")
  derivedExperienceLevel   String   @default("Beginner") @map("derived_experience_level") @db.VarChar(20)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt                DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([derivedExperienceLevel], name: "idx_derived_experience_level")
  @@index([softwareExperienceYears], name: "idx_software_experience")
  @@index([hardwareExperienceYears], name: "idx_hardware_experience")
  @@map("user_profiles")
}

// User sessions table - JWT authentication
model UserSession {
  id               String    @id @db.VarChar(255)
  userId           String    @map("user_id") @db.VarChar(255)
  token            String    @unique @map("token") @db.VarChar(255)
  expiresAt        DateTime  @map("expires_at") @db.Timestamp()
  ipAddress        String?   @map("ip_address") @db.Text


  userAgent        String?   @map("user_agent") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_user_sessions_user_id")
  @@index([token], name: "idx_user_sessions_token")
  @@index([expiresAt], name: "idx_user_sessions_expires")
  @@map("user_sessions")
}

// Tab preferences table - content view preferences
model TabPreference {
  userId    String   @id @map("user_id") @db.VarChar(255)
  activeTab String   @default("original") @map("active_tab") @db.VarChar(20)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([updatedAt], name: "idx_tab_preferences_updated")
  @@map("tab_preferences")
}
